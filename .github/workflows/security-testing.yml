name: Security Testing and Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run npm audit
      run: npm audit --audit-level=high
      
    - name: Run Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
        
    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v2
      with:
        languages: javascript
        
    - name: Autobuild
      uses: github/codeql-action/autobuild@v2
      
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2

  dependency-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'hairathome'
        path: '.'
        format: 'HTML'
        
    - name: Upload Dependency Check Results
      uses: actions/upload-artifact@v3
      with:
        name: dependency-check-report
        path: reports/

  static-analysis:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run ESLint security scan
      run: npx eslint . --ext .js,.html --config .eslintrc.security.js
      
    - name: Run Semgrep security scan
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/javascript
          p/html
          
    - name: Run SonarCloud scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  dynamic-security-testing:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Start application
      run: npm run serve &
      
    - name: Wait for application to start
      run: sleep 10
      
    - name: Run OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.7.0
      with:
        target: 'http://localhost:8000'
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'
        
    - name: Run Nuclei vulnerability scan
      uses: projectdiscovery/nuclei-action@main
      with:
        target: 'http://localhost:8000'
        templates: '/nuclei-templates/'
        
    - name: Stop application
      run: pkill -f "python3 -m http.server"

  infrastructure-security:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Checkov IaC scan
      uses: bridgecrewio/checkov-action@master
      with:
        directory: config/
        framework: cloudformation
        output_format: sarif
        output_file_path: reports/checkov-results.sarif
        
    - name: Run Tfsec scan
      uses: aquasecurity/tfsec-action@master
      with:
        directory: config/
        format: sarif
        out_file: reports/tfsec-results.sarif
        
    - name: Upload infrastructure scan results
      uses: actions/upload-artifact@v3
      with:
        name: infrastructure-security-results
        path: reports/

  container-security:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build Docker image
      run: |
        docker build -t hairathome:latest .
        
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'hairathome:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Run Grype vulnerability scanner
      uses: anchore/scan-action@v3
      with:
        image: 'hairathome:latest'
        fail-build: true
        severity-cutoff: 'high'
        
    - name: Upload container scan results
      uses: actions/upload-artifact@v3
      with:
        name: container-security-results
        path: trivy-results.sarif

  secrets-detection:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Run TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        
    - name: Run GitGuardian scan
      uses: GitGuardian/ggshield-action@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

  security-headers-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Start application
      run: npm run serve &
      
    - name: Wait for application to start
      run: sleep 10
      
    - name: Check security headers
      run: |
        curl -I http://localhost:8000 > headers.txt
        cat headers.txt
        
        # Check for required security headers
        grep -i "strict-transport-security" headers.txt || echo "HSTS header missing"
        grep -i "content-security-policy" headers.txt || echo "CSP header missing"
        grep -i "x-frame-options" headers.txt || echo "X-Frame-Options header missing"
        grep -i "x-content-type-options" headers.txt || echo "X-Content-Type-Options header missing"
        grep -i "x-xss-protection" headers.txt || echo "X-XSS-Protection header missing"
        grep -i "referrer-policy" headers.txt || echo "Referrer-Policy header missing"
        
    - name: Stop application
      run: pkill -f "python3 -m http.server"

  ssl-tls-check:
    runs-on: ubuntu-latest
    steps:
    - name: Check SSL/TLS configuration
      run: |
        # Install testssl.sh
        git clone --depth 1 https://github.com/drwetter/testssl.sh.git
        cd testssl.sh
        
        # Run SSL/TLS tests (replace with actual domain)
        ./testssl.sh --quiet --color 0 --jsonfile ssl-results.json https://hairathome.ca || true
        
        # Upload results if file exists
        if [ -f ssl-results.json ]; then
          mkdir -p ../reports
          cp ssl-results.json ../reports/
        fi
        
    - name: Upload SSL/TLS results
      uses: actions/upload-artifact@v3
      with:
        name: ssl-tls-results
        path: reports/
      if: success()

  security-reporting:
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-check, static-analysis, dynamic-security-testing, infrastructure-security, container-security, secrets-detection, security-headers-check]
    if: always()
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      
    - name: Generate security report
      run: |
        echo "# Security Testing Report" > security-report.md
        echo "Generated on: $(date)" >> security-report.md
        echo "" >> security-report.md
        
        echo "## Test Results Summary" >> security-report.md
        echo "- Security Scan: ${{ needs.security-scan.result }}" >> security-report.md
        echo "- Dependency Check: ${{ needs.dependency-check.result }}" >> security-report.md
        echo "- Static Analysis: ${{ needs.static-analysis.result }}" >> security-report.md
        echo "- Dynamic Testing: ${{ needs.dynamic-security-testing.result }}" >> security-report.md
        echo "- Infrastructure Security: ${{ needs.infrastructure-security.result }}" >> security-report.md
        echo "- Container Security: ${{ needs.container-security.result }}" >> security-report.md
        echo "- Secrets Detection: ${{ needs.secrets-detection.result }}" >> security-report.md
        echo "- Security Headers: ${{ needs.security-headers-check.result }}" >> security-report.md
        echo "" >> security-report.md
        
        echo "## Detailed Results" >> security-report.md
        echo "Please check the uploaded artifacts for detailed security scan results." >> security-report.md
        
    - name: Upload security report
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: security-report.md
        
    - name: Comment PR with security results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('security-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## üîí Security Testing Results\n\n${report}`
          });

  security-gate:
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-check, static-analysis, dynamic-security-testing, infrastructure-security, container-security, secrets-detection]
    if: always()
    steps:
    - name: Check security gate
      run: |
        # Define security gate criteria
        SECURITY_SCAN_RESULT="${{ needs.security-scan.result }}"
        DEPENDENCY_CHECK_RESULT="${{ needs.dependency-check.result }}"
        STATIC_ANALYSIS_RESULT="${{ needs.static-analysis.result }}"
        DYNAMIC_TESTING_RESULT="${{ needs.dynamic-security-testing.result }}"
        INFRASTRUCTURITY_RESULT="${{ needs.infrastructure-security.result }}"
        CONTAINER_RESULT="${{ needs.container-security.result }}"
        SECRETS_RESULT="${{ needs.secrets-detection.result }}"
        
        # Check if any critical security test failed
        if [[ "$SECURITY_SCAN_RESULT" == "failure" || "$DEPENDENCY_CHECK_RESULT" == "failure" || "$STATIC_ANALYSIS_RESULT" == "failure" || "$DYNAMIC_TESTING_RESULT" == "failure" || "$INFRASTRUCTURITY_RESULT" == "failure" || "$CONTAINER_RESULT" == "failure" || "$SECRETS_RESULT" == "failure" ]]; then
          echo "‚ùå Security gate failed - One or more security tests failed"
          exit 1
        else
          echo "‚úÖ Security gate passed - All security tests passed"
        fi